#include "rsa.h"
#include "hash.h"
#include "hash.c"

char Node_IPs[NUM_NODES][16] = {
    "10.35.70.7",
    "10.35.70.27",
    "10.35.70.37",
    "10.35.70.47",
    "10.35.70.57"};

char *Node_PubKeys[NUM_NODES] = {
    "bc1b51e0c075f8589b0d5073f07ef25f913d72b652bca1361eddda9e164f88d75d7aee87c14bcdd68e19bfd25d51ab9510d0e0fafc2f1af7830bec1f2398aff5dfb73886d04e54587fe712eab402f8704998920176f7057396f0bb93e54db98b3bdb8217253eee7e6112c4e3f9e74240b17100cdcc597c978665eff09c9d17daf03a4d3831b1fcd06fa65b53a8b4af9a539053e3a10b392672883b85fb75c25dc47f5c7546c10344e5b1560b3dde6a751f3bc40be0fac12916e458153749706732ce73d6fc5a2c786e5396bb40690d8597cbc8f4cfda339b009bfa266cd3c85b91cf8dbf6a3d5ec012800496496d92d2ccb2643a42dd5de95447004ad8d04d9b72316ef8f67abed88f336cb323f94a2042bbe6fb1290fe8d3c38ae16b037d47755f37962e2e5294d1f33cfe7ce58b2b6bd95868493550cb5dba4029312fcc381a026baf74746b1817c327817f4e6c49fa8c6ad7dbc33a18b5a7af1a471c605cf0f2a804c7b8ef7eb248f79b3d00e5922ebfaac2829167b2326ed5c990d50d51d18f6b67db1bc487650fb89a37daafd54c4f1dd9b420958587ece9ceb006eb2bb82ba06f9df64fe0911784dd1422441749939a26071180d00851e64d5d4b375264970560e673d0d52e7a9408e555304bdce1eb5a7894b40bd72f98684538d78c7426ce3c51bda35f0219d73ee74aebb5f31fef355ea7e23b2b355331158b621b",
    "88291bbbe2e0b3e3a04a2e2ccc422121755cc73686a4470b9f5bea624282527661c3ae0c2960ff618a116474ffeace39861b0cc1dbd03babeafc1742df9a2b0b8fbdc96f196513b913ef3be1bd735891cc42452d4fa68a6a7dd6a2359adb2edd426286d3c6ad580dd56a208625a02daedd8e16ad74e941bbbeaf4b5f252ee0bb90bf0c6a02af33dad805d857bb68d91b90eb0b5b1235597ceb969f6c8a908d2c0787bcbb905c29133b211754a7f605bafe0cff1a9ee24114e31dd5bc7ca9fabeda9e4e3f3e11f2d4bd5b319ee54457b480b2d2916b6941e794b4f01c45e0152ce864d754bd179cb217d34397cdce4d6db2b04d59d114baba0b0ab89a03453524d9e0ee833adb6d85817f459b78c10010180d1791a2dc00676982ebbcdf7488c0a1f219cd18481375e9bd13982fca58c38b0556ef4afbbf6f92092d4e71dd64d0f6f8b58574f28a0fa9c809305d52f60f99abffe7d392225164de225d86d976ff5ab8692dc73e6668e0d45e6186c7405f46ee04ed8318d7fdd633a2e726ca6dbd18e8437d260d7c293893ff356daa58e0fe94b39e0e3d46affc0d1cfb3ff2baab692593fdb6e6f378c54a0103fa54c8ea2420ad8af623f8525df429620f7de173a7deee6bed7e9a56e4eed8df748f1751252a35d95c71c768aa1723ae441ce3c7819dbf3fd94dc2d908d0b2fb91c166976660922e5afacd64483348e269ab09af",
    "165eeacd99d15fcbfa08e59ac0667b822054dc861374079869be59a4a84bcb4ce034b55378ae55cfbcba5dd64d434dc23f1159556f70a1193c6026d9c69021ba12438ccf7f681fdfee30f5b27762c5c5c842df024523a8585adc7332c221ba5bcd79dca53d9eb8db94d98d4bb3264522d5548f7dc131e1920d23ae5c9d07ea85d2d49a6f33d605d27035534d0c5927a0cab89ec93c9bc48c3f5c8fac590e812643d44161a0e80a87ff6e02232396b1744585e41599564fb3ba4ea1d0d4aba93818765a1d734828617222fc2e414b90d15615591316eca9a5305833e111f618410769af2a66b9bfb490568f7bad893d538f2fa61bbc6e89235331236375eb8f20ab56bff2e96af2655747135a8f29759dc289cac42511424b2aa099e4c3ce2a5a89fd73b78bb2caf289aa689fb99d9d12be439f687d6e1bf332194e8d6748041332464be1a08b23cf61b67a425316ceba8e4c78958a88cc68e542cc9bd14524cf30e52dd2c4b0d33be4e28a507d985ca2ca644cdc20fe823c8da5245b1e942e8c27b31fd33303acb87e3d05605d93e28308fa9574c763a635583cb90bad6193c9d78c95a56c6e82a7d46fe1488ae7cae20bf1a4eeeb0eef1d8db29640eb6c5ce2ffd612e0fe9c16771edc4c9ac3e3ec007d0da00dccc11dbca98318307b2f43c6ea8a04f0ea8e19ae5bc6594b10c66c704d95784a56621dad4321bee4be57b175",
    "6d8f8501a22fce991a8d1dd31e7cf6184640b9afc4661408886d8a8cd2c34cfebdb0315e2f5413147bb1d486107aa02f4e3c3920d84095802a7fab34f598224ae8c6bcfd14d3cb3c1932be377ada79cf4b57e53e7318af57ccb778f0e2d02d186b8e688ac19be538651bd8527581378220d55e9ce92fb5aafcd933f52b1b6a316e4114771cd2d0bdbdcaca5cfb83ef6219208b84b2b513b70b651d834ed3cc6b27f54f6df0428115ed7e31e4dfcef013df4ebbc19ec7aead6ea078158230363edb0ce7ad83ac87b1f12ef77e0634926fb973b78506c59e4986dde9100cdfa0811ccb1c19388ec6b9df9aa232d2a4cb278e8c82c712c02b67e3f11259e90fed9ffa0c23717358d575e252a3f702928c3e08ee523b7f29465c9be3702ef747f33ae89a8a958403dda9c73bb21e58708c719fb1f5905e98bdf8bae8dcb9c78eca91ffd70fa384cc24a051b0d0168b7ef8d7d3ca0607f37e8836b50b0cff456070db5840222933a461295e8c19878b932b8d9c83b76967190da9d3470f5ef92aed92b316a57aae14426605c253c566a42c95167a06655faf0c642ea6fb40a008f3b9dc71baf327409e8b51f623584b30b49d39cba309083610d46f2797f45707bcb92a470e3886adb5bb5e9c41c141bb50841af1c3f9517e8515901aeb8474ffbfa2cfae7db680cf895d6c1bdc4f9e882add7f1d2b0405409bb13f72c37d82fc1449",
    "2ee6ca59f1c979557a6aaa9696af23efceca929fea22748bc284ef14b637df477968f197d7feb9372db4bf47fb639c1fd8c4a403726319acb36c167989b16735cba1613b24abe0b8dd39e6b71fb0869abcdb67b12e638b17f7b1b9dafbdb9492adeddd88b4cde39bdd7b093e2687b04ba249335ffb7803e75fcc56cc168ed7eb7452259160328ac981816bf657aeb9d8eb1fb202a0c61f9b6d66e12ffb4b417b10e4c55f0c0fe6cfe5c13afdf7881a320c0c6a39603e0c0d1638912eda742120fd073d1c111cfe0dbf784d98b5b91793cbde6cc7cdfad6df5564eaf055331f1043ed4884025ed7cff4f7e3488611cbb88263b0455c1b43cb25d6408a97add852c1f902eb3da2b9ca1697b6ad47f6aba3840d65415f7075fbf29df1a68ec5c5fa0d8361b1437c43fae9eda2691e574134283c225e8b36ba6b92908c9979597b67e2e7c1334c64476f3f099f4e2661e8e901d4ef0ead55159a08dcfd86756888740a0816251e6b52eab54a285e42efe47c4864df985128471b7c6d9c33fb49412884c943e0df1ec38a2d5a501311fba64df5aeca422d7e9bff570071b947d1025985793c3948d2a16290e8b0db531e7095ce6f3332ae02aeee17ab5b04a4a0d340ac0c9b3ffb4a7aa50955add7cc0afada1f51e0e5b71d015506ba0fb7b44142cdcf8d1c54897bfe742a34772439af47ee3bf7e9cacc2a72e24364110399eb98cd",
};

/*
PRIV KEY 1: 83687677931c16a51794628acc0c73178e282635f670ae1257d7d67cafcb5a2651b8aa600e09fdbf10402ec02fcef915c6cc950ee113ab3c13c1456faf77601d5ceeeb3f4ad01d9e41a3d4943fb2ff89b9f02ab7793b3204c1026597f90da63bfd51e87c70d998d492ce00dbde5dceebd0c9c7acfd3fda89242b9c4633b28ed2b5159592572d27171998569e87f1c9e6fecf89bb306addbedd2e0c9f19bef74c78141d2c14848bdb1ab71b0bf969a26735ad93d45493f852d31a2bea8e57f07d3782006cc497de0f37cb8f363ad5e8cb55f2d7ed263321effba9fb43d2acd4801bc9aa15798b6be0b44bd86880dd5a3f871e6c644307d02e4b60da746f287db6e14a1e5988d9212e2c2d626618b4e7ea5fe5c4232238aafac314cf6ad9524f279c3622e3f0bcc52da3215af939f9b503507249f81473299a5ef03a83a853a111bbc4ce0b28852733d208f9b857028f61cf05e6ad461e003feb84d208c2b7f8a155a87f297deb5ffc9e0467647bfcf3147974e1a3a28f47d3613cd1c5300909adbc5c33c35bd3cee114ad227deafde4d0b3927eb53d0fba86fffaac10045c4f8b9c9e6248422935017906c4933a7a1df005297786ca61ffda82508c242671b6b570831ed8b66062e349dba8684f7a70d0b48c487019a82cba59dd983db98b87d9b59909c719c72dee1677808e24a98eabb242418aac3291a5a3d16991080c159
PRIV KEY 2: 308f60a9c07f5d08a868ec50e3c40de6cde179d6d36c113e6ee62c1041221360cefb27be849f68551415a1db2c4e44a03558be53011f21b8ed845c936805a6a667ec4ac3c9adc7bbf10518392904d328a44d5a388fb89892e43041079723e671d8b424dbb076aff9b70c336f4449fd20e9393c933e27d65eabe1fea27f3359c8eb1587cae30c33153087dd2164e03ed5daf848c38119efc162900469847d8b2b91bff22a7e90afc1810c0b3310f7e811497bbf1b7260c4cf3b34afbe9a4350fef21f154eeec71df08b5bd3b59494ac26dee367bf9f2c19ea0a9a012c442b67c1ed5bd1841230329d3d6c062644aaf7e8509b19eb176b2a3121b100274555505f3bb5fb6b788dc83ae93c26e02374ae832cad407d759cd5dd4f685ac208e5c2d822688fa8892ede94d5ef39a032371a62c69c63d4f9cda7dc9aaffb2def86b690f25ece47b0da3055ce6f956bd0d6f2d8abcaf8955b4f786671dc5b5de3a919f65fc2cd46bc67a69c57af475a950c15d5f7be9890aca54aff0c9005e0e83f6c6df7bd2bba8b6d9eb0b68a9d2eaf21b587695e6cded992297cea9bbf70a023fa3c76b7636e3b8faaba35e9801052e416ddfab62be7bb541349d60614a92ef09fb87d294c7ad52558369b4104cac882f385e8b32c4dc78a8248943b6722addc9d6ca46b00835bcb2681af519b37aaca2ed7fc82a710592cc15662d63d59d8710709
PRIV KEY 3: 12e21c2160edb387628f900088d7f8f966813b84917727d227b05dcaf7a4c2ff2962548d19194fa60310ed94afb35837d734b5cbc03dba3eab101ebb4538f4bf341b8108c5eb06bce73abcaae0cba755c42d6e41644b2d1727db5e02428c65da881f8d788e0324d775560e470ffa05f1d9517fae0f1e23e23ce51991639c0302e36c42d00b5965a0b4c6ce8203225ea90375c3d2ea2e32429059798d69bf2c95383c3ad44616988d23b7a06638ec42ee7aa1025e99089a4e83bd4c2a12dab4047de1a93fa2c80e0df36244ac66c17a84b9bd5b6b19b6bb9c8caa67605ce0f6a82db1b00282a3d8867a3016fdb7065995e70fb98f4007ae0afb764700f5d0d9079b7ccb00b64bfae4d9c48de368a375cf4ad41ef919782b3c7acd38cbf726c0f80e1150476cd15a9d46bd3d11f7ba4d164c22d96f72c3bf70c4d3af415ac177f8c1961883e50610bd65a5de1d397f6b7ebb756ac84c616b8b5525980c6839e62f068ab7e3514c966a0cc330296e2cf9c51fd5a4dea7accbeebc03b05bb551f1d0e40025b72549cce0f3a16e512ad8c89914cf7723e6a885578e667c197a1fd9a32c1ff408541fdd9bb3ce9c71476b3cfe1076cc34baada08fb2dbdf42581201c1ba52caf2d8ae9e2c35f31afc88cbd237822b727a39d3e075527419bac89fe6b9c62dae19f325426f474378b3214bddf6ca2012767c827361a7bcec997eeb6a21
PRIV KEY 4: 2205efc81215c692c52c0d970260cc0bbdc55be4b998f99facbe57c863ab42bdd92a5e2a61883a64a205177a8aa38a1b26b08d0d261ae85264e040cab17a0d2c361d81931664af387a9ac777732f65a47a41516f934e97252cedcd21014ea4b270b448c2ce5d1b51e8143d995de442d8a6599c881de23308667d0d2595bd6dbcec0049dab398c43a283651a18e79ea5d0c708ee3269c15034306a3a3a35722a4244489e61a368cdfc260ee1da5631e2b0dade5a0bb2e4790944a41006ced8beaf91b88d6d98d3a9687cf8e0c14e13e98737efbfed39b8b0c4a559f8adc7495e3828d90ac44641252a69ddec0e9a9436d85571d45b50cf86dcadb9257598918c1a74f3d4f6e961bbf054c62022b19e41429945c2be13525cef5ea54d9265624ce5d85d40c51cd33d6ee322bca406bccf5a21a18ac177b49a4468171031c6b9b444c30d42abfdc26cf73e2751b040ada2cccf1d1060096acd0e82a206c17cc60b76049627ebdaa9ada294ed21da9e9e388f2bb40b650369f950cbac35bb61b6c3eb670fd5845401e62f85bf3a407e1a447598ddd44c5f37d43731d9470f0ed39c7bbbe14db4057f97b59fbae2cd52e09fea27cc9d2fa4bb5a13ef18de81dc68474b529bdccd39977b15ecbd9f91be922f1de3c6d0bec9e0cbed21d5eccb7177a1653de806d8f00514f58932bc78b1eb430e98291c189c4be3ee361a4016f25fe1
PRIV KEY 5: b2252cb4370f6d2e9fac48077492098df588bb256dcd31a129588443c75cb15a6a6d92398ed297f05e4b0bc1fdba7c68fa92ede7a9b380f1d90fd4ce0f9326d3ce814b2fba3a9f778dd33fe2911b902a6eed710e2d852bedfd85b2cb7398b6dbec8871cdaff3d9754dece74e8a4b19f62e949bef16dae4f91186b4a8bd8613dce216a35b6c688d8095c760ac709fda89738b1039ab32df1b1e9087061919dfbdf28d00a1e4cf0184e8caeba77b6e1b11bd71ea87c467e89e4ca8cfcb8737521e5af803c577bb07c070642358c7e62307de7519fa530752e13919f8c6a4d76845ffbc689401ecfd0d870b88e10f5cc8d02b733b363883d71ce8bac4aba7354b527dab93575cbcea0f2042271c55c8d0486bbea0b624aeccbd94f9674fe9790f00b6e7e10b7c419eec828a288cd24e3d2e2db39c6a67b2ee1daa07227976a05a8053248dff5bfc21bbfbe22e129814aef85b4d35f93604e86d3b2ca17a92adcd3d07cded50f2afe0ce7787185105c889cf0be7ca1389812e087ed748ea869b9c250210ec0e7dd9dd793de5ff0e6251fdb902d2a712e3aebe95cc7e7a1c9b6265aad2ac808af492bdb7e194e05b12c6829d719a4f39e739aad28a6a60e9a67ff69394f72adfedc27ba6b19a629942c87506aa58a10deb7863c9cae5665eb0f7bd704db18714685a5677c227022907b3345f05f68d744778cc07da53f4cd7f6f729
*/

char **rsaGetPubKey(char *IP)
{
    for (int i = 0; i < NUM_NODES; i++)
    {
        if (strcmp(IP, Node_IPs[i]) == 0)
        {
            // If IP is found in the network list, find public Key
            // printf("Key FOUND\n");
            // printf("%s\n", Node_PubKeys[i]);
            return &Node_PubKeys[i];
        }
    }
    return NULL; // Return null if no ip found
}

int verifySig(char *IP, char *rawMsg, char *signature)
{
    char *hashString = sha256(rawMsg);

    return strcmp(hashString, rsaDecrypt(signature, *rsaGetPubKey(IP))) == 0;
}

char *rsaEncrypt(char *hashedInput, char *privKey, char *pubKey)
{
    mpz_t hash, d, n, encrypted;
    mpz_init_set_str(hash, hashedInput, 16);
    mpz_init_set_str(d, privKey, 16);
    mpz_init_set_str(n, pubKey, 16);
    mpz_init(encrypted);

    mpz_powm(encrypted, hash, d, n); // encrypted = hash^d mod n

    // gmp_printf("encryto: %#Zx\n", encrypted);
    char *encryptedOutput = mpz_get_str(NULL, 16, encrypted);

    mpz_clears(hash, d, n, encrypted, NULL); // free memory
    return encryptedOutput;                  // need to free later
}

char *rsaDecrypt(char *encryptedInput, char *pubKey)
{
    mpz_t encrypted, n, e, decrypted;
    mpz_init_set_str(encrypted, encryptedInput, 16);
    mpz_init_set_str(n, pubKey, 16);
    mpz_init_set_str(e, "65537", 10); // e = 65537
    mpz_init(decrypted);

    mpz_powm(decrypted, encrypted, e, n); // decrypted = encrypted^e mod n

    char *decryptedOutput = mpz_get_str(NULL, 16, decrypted);

    mpz_clears(encrypted, n, e, decrypted, NULL); // free memory
    return decryptedOutput;                       // need to free later
}
